

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// ENUMS
//
enum UserRole {
  SUPER_ADMIN
  ADMIN
  POLICE
  FIRE_SERVICE
  CITIZEN
}

enum ComplaintType {
  TRAFFIC
  INFRASTRUCTURE
  TRAFFIC_VIOLATION
}

enum CameraStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
  OFFLINE
}

enum VehicleType {
  CAR
  MOTORCYCLE
  TRUCK
  BUS
  BICYCLE
  OTHER
}

enum ViolationStatus {
  PENDING
  CONFIRMED
  DISPUTED
  RESOLVED
}

enum FineStatus {
  UNPAID
  PAID
  CANCELLED
  DISPUTED
}

enum PaymentMethod {
  CASH
  CARD
  BANK_TRANSFER
  MOBILE_MONEY
  ONLINE
}

enum AddressType {
  HOME
  OFFICE
  STATION
  SERVICE_CENTER
  OTHER
}

enum LocationType {
  POLICE_STATION
  FIRE_SERVICE
  CAMERA
  INCIDENT
  COMPLAINT
  VIOLATION
}

enum PoliceHierarchyLevel {
  HEADQUARTERS      // National/Central level
  RANGE            // Regional level
  DISTRICT         // District level  
  CIRCLE           // Circle level
  STATION          // Station level (actual police stations)
  OUTPOST          // Sub-station/outpost level
}

enum StationStatus {
  ACTIVE
  INACTIVE
  UNDER_CONSTRUCTION
  TEMPORARY_CLOSED
}

enum LicenseCategory {
  LIGHT_VEHICLE           // Light vehicle (cars, small vans)
  MOTORCYCLE             // Motorcycle only
  LIGHT_VEHICLE_MOTORCYCLE // Combined light vehicle + motorcycle
  HEAVY_VEHICLE          // Heavy vehicles (trucks, buses)
  PSV                    // Public Service Vehicle
  GOODS_VEHICLE          // Commercial goods vehicle
}

//
// NORMALIZED MODELS
//

// Location management - normalized to eliminate redundant lat/lng data
model Location {
  id          String      @id @default(uuid())
  latitude    Float
  longitude   Float
  address     String?
  city        String?
  district    String?
  division    String?
  country     String      @default("Bangladesh")
  postalCode  String?
  type        LocationType
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  policeOrganizations PoliceOrganization[]
  policeStations      PoliceStation[]
  fireServices        FireService[]
  cameras             Camera[]
  violations          Violation[]
  incidents           Incident[]
  complaints          Complaint[]

  @@index([latitude, longitude])
  @@index([type])
  @@map("locations")
}

// Contact information - normalized to avoid repetition
model ContactInfo {
  id          String   @id @default(uuid())
  phone       String?
  email       String?
  website     String?
  emergencyPhone String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  policeOrganizations PoliceOrganization[]
  policeStations      PoliceStation[]
  fireServices        FireService[]

  @@map("contact_info")
}

//
// HIERARCHICAL POLICE ORGANIZATION MODELS
//

// Police organizational hierarchy - normalized structure
model PoliceOrganization {
  id            String              @id @default(uuid())
  name          String              // e.g., "Bangladesh Police", "Dhaka Metropolitan Police"
  code          String              @unique // e.g., "BP", "DMP", "RMP"
  level         PoliceHierarchyLevel
  description   String?
  
  // Self-referencing hierarchy
  parentId      String?
  parent        PoliceOrganization? @relation("Hierarchy", fields: [parentId], references: [id])
  children      PoliceOrganization[] @relation("Hierarchy")
  
  // Relations to actual stations
  stations      PoliceStation[]
  
  // Normalized location and contact
  locationId    String?
  location      Location?           @relation(fields: [locationId], references: [id])
  contactId     String?
  contact       ContactInfo?        @relation(fields: [contactId], references: [id])
  
  // Administrative details
  headOfficerId String?             // Officer in charge
  headOfficer   User?               @relation("OrganizationHead", fields: [headOfficerId], references: [id])
  
  isActive      Boolean             @default(true)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@index([level])
  @@index([parentId])
  @@index([code])
  @@index([isActive])
  @@map("police_organizations")
}

//
// CORE MODELS
//
model User {
  id                    String          @id @default(uuid())
  firstName             String
  lastName              String
  phone                 String
  email                 String          @unique
  password              String
  role                  UserRole        @default(CITIZEN)
  designation           String?         // Job title/position (e.g., "Inspector", "Sub-Inspector", "Constable", "Chief", etc.)
  nidNo                 String?         @unique
  birthCertificateNo    String?         @unique
  profileImage          String?
  
  // Personal Information
  dateOfBirth           DateTime?
  gender                String?         // "MALE", "FEMALE", "OTHER"
  bloodGroup            String?         // "A+", "B+", "O+", etc.
  
  // Contact Information
  alternatePhone        String?
  emergencyContact      String?
  emergencyContactPhone String?
  
  // Address Information
  presentAddress        String?
  presentCity           String?
  presentDistrict       String?
  presentDivision       String?
  presentPostalCode     String?
  
  permanentAddress      String?
  permanentCity         String?
  permanentDistrict     String?
  permanentDivision     String?
  permanentPostalCode   String?
  
  // Driving License Information
  drivingLicenseNo      String?         @unique
  drivingLicenseIssueDate DateTime?
  drivingLicenseExpiryDate DateTime?
  drivingLicenseCategory String?       // "MOTORCYCLE", "CAR", "HEAVY", "PROFESSIONAL", etc.
  isDrivingLicenseVerified Boolean     @default(false)
  
  // Professional Information (for police/fire service)
  badgeNo              String?         @unique // Police badge number
  joiningDate          DateTime?       // Date of joining service
  serviceLength        Int?            // Years of service
  rank                 String?         // Police rank (Constable, ASI, SI, Inspector, etc.)
  specialization       String?         // Area of expertise
  
  // Email verification fields
  isEmailVerified       Boolean         @default(false)
  emailVerificationToken String?
  emailVerificationExpires DateTime?
  
  // Password reset fields
  passwordResetToken    String?
  passwordResetExpires  DateTime?
  
  // Status fields
  isDeleted             Boolean         @default(false)
  isBlocked             Boolean         @default(false)
  isActive              Boolean         @default(true)
  blockedAt             DateTime?
  unblockedAt           DateTime?
  verifiedAt            DateTime?
  blockedBy             String?
  unblockedBy           String?
  verifiedBy            String?
  blockReason           String?
  
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  // Relations
  stationId      String?
  station        PoliceStation?  @relation(fields: [stationId], references: [id])
  
  // Police hierarchy relations
  headsOrganizations PoliceOrganization[] @relation("OrganizationHead")
  stationAsOC        PoliceStation[]     @relation("StationOC")
  
  vehiclesOwned  Vehicle[]       @relation("OwnerVehicles")
  vehiclesDriven Vehicle[]       @relation("DriverVehicles")
  payments       Payment[]
  citizenGem         CitizenGem?
  incidents          Incident[]
  complaints         Complaint[]
  vehicleAssignments VehicleAssignment[] @relation("VehicleAssignments")
  assignmentsMade    VehicleAssignment[] @relation("AssignmentsMade")
  drivingLicenses    DrivingLicense[]    @relation("DrivingLicenses")

  @@index([email])
  @@index([nidNo])
  @@index([birthCertificateNo])
  @@index([isEmailVerified])
  @@map("users")
}

model PoliceStation {
  id              String             @id @default(uuid())
  name            String
  code            String             @unique  // Station code (e.g., "DMP-RAM-001", "RMP-CTG-002")
  stationType     String?            // "THANA", "OUTPOST", "TRAFFIC", "SPECIAL"
  status          StationStatus      @default(ACTIVE)
  
  // Hierarchical organization relation
  organizationId  String?
  organization    PoliceOrganization? @relation(fields: [organizationId], references: [id])
  
  // Normalized relations
  locationId      String?
  location        Location?          @relation(fields: [locationId], references: [id])
  contactId       String?
  contact         ContactInfo?       @relation(fields: [contactId], references: [id])
  
  // Station management
  officerInChargeId String?          // OC (Officer in Charge)
  officerInCharge   User?            @relation("StationOC", fields: [officerInChargeId], references: [id])
  
  // Capacity and resources
  capacity        Int?               // Number of officers/staff capacity
  currentStrength Int?               // Current number of officers
  
  // Relations
  cameras         Camera[]
  users           User[]            // Officers assigned to this station
  incidents       Incident[]        // Incidents handled by this station
  complaints      Complaint[]       // Complaints filed at this station
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([code])
  @@index([organizationId])
  @@index([status])
  @@index([stationType])
  @@map("police_stations")
}

model FireService {
  id          String      @id @default(uuid())
  name        String
  code        String      @unique  // Service code (e.g., "FSCD-DHK-01")
  
  // Normalized relations
  locationId   String?
  location     Location?   @relation(fields: [locationId], references: [id])
  contactId    String?
  contact      ContactInfo? @relation(fields: [contactId], references: [id])
  
  // Relations
  cameras      Camera[]
  
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([code])
  @@map("fire_services")
}

model Camera {
  id            String         @id @default(uuid())
  name          String?        // Camera identifier/name
  streamUrl     String
  installedAt   DateTime
  status        CameraStatus   @default(ACTIVE)
  
  // Normalized location
  locationId    String?
  location      Location?      @relation(fields: [locationId], references: [id])
  
  // Relations to stations/services
  stationId     String?
  station       PoliceStation? @relation(fields: [stationId], references: [id])
  fireServiceId String?
  fireService   FireService?   @relation(fields: [fireServiceId], references: [id])
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([status])
  @@index([installedAt])
  @@map("cameras")
}

model Rule {
  id          String      @id @default(uuid())
  code        String      @unique
  title       String      // Short title for the rule
  description String
  penalty     Int?        // Default penalty amount
  isActive    Boolean     @default(true)
  
  violations  Violation[]
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([code])
  @@index([isActive])
  @@map("rules")
}

model Vehicle {
  id           String      @id @default(uuid())
  type         VehicleType
  plateNo      String      @unique
  brand        String?     // Vehicle manufacturer (Toyota, Honda, etc.) - renamed from make
  model        String?     // Vehicle model (Corolla, Civic, etc.)
  year         Int?        // Manufacturing year
  color        String?     // Vehicle color
  engineNo     String      @unique // Engine number - required field
  chassisNo    String      @unique // Chassis number - required field
  registrationNo String?   @unique // Registration number - optional separate from plate
  
  ownerId      String
  owner        User        @relation("OwnerVehicles", fields: [ownerId], references: [id])
  driverId     String? 
  driver       User?       @relation("DriverVehicles", fields: [driverId], references: [id])
  
  registeredAt DateTime    @default(now())
  expiresAt    DateTime?   // Registration expiry date
  isDeleted    Boolean     @default(false)
  isActive     Boolean     @default(true)
  
  violations   Violation[]
  assignments  VehicleAssignment[]
  
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([plateNo])
  @@index([engineNo])
  @@index([chassisNo])
  @@index([ownerId])
  @@index([driverId])
  @@index([isActive])
  @@map("vehicles")
}

model Violation {
  id          String          @id @default(uuid())
  ruleId      String
  rule        Rule            @relation(fields: [ruleId], references: [id])
  vehicleId   String
  vehicle     Vehicle         @relation(fields: [vehicleId], references: [id])
  
  // Normalized location
  locationId  String?
  location    Location?       @relation(fields: [locationId], references: [id])
  
  description String?
  status      ViolationStatus @default(PENDING)
  evidenceUrl String?         // Photo/video evidence URL
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  fine        Fine?

  @@index([vehicleId])
  @@index([ruleId])
  @@index([status])
  @@index([createdAt])
  @@map("violations")
}

model Fine {
  id          String      @id @default(uuid())
  violationId String      @unique
  violation   Violation   @relation(fields: [violationId], references: [id])
  amount      Int
  status      FineStatus  @default(UNPAID)
  dueDate     DateTime?   // When the fine is due
  issuedAt    DateTime    @default(now())
  paidAt      DateTime?   // When fully paid
  payments    Payment[]
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([status])
  @@index([dueDate])
  @@index([issuedAt])
  @@map("fines")
}

model Payment {
  id              String        @id @default(uuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id])
  fineId          String
  fine            Fine          @relation(fields: [fineId], references: [id])
  amount          Int
  transactionId   String?       // External transaction reference
  paymentMethod   PaymentMethod
  paymentStatus   String        @default("COMPLETED") // PENDING, COMPLETED, FAILED, REFUNDED
  
  paidAt          DateTime
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([userId])
  @@index([fineId])
  @@index([paymentStatus])
  @@index([paidAt])
  @@map("payments")
}

model Incident {
  id           String    @id @default(uuid())
  externalId   String?   @unique // External ID for AI service integration
  type         String    // ACCIDENT, FIRE, TRAFFIC_VIOLATION, etc.
  title        String
  description  String?
  priority     String?   // HIGH, MEDIUM, LOW
  severity     String?   // LOW, MEDIUM, HIGH, CRITICAL
  status       String    @default("REPORTED") // REPORTED, IN_PROGRESS, RESOLVED, CLOSED
  
  // Location data - can be either normalized or direct
  locationId   String?
  location     Location? @relation(fields: [locationId], references: [id])
  
  // Direct location data for AI integration
  latitude     Float?
  longitude    Float?
  address      String?
  
  // Metadata for AI integration
  metadata     Json?     // Store AI confidence, vehicles involved, etc.
  
  reportedById String?
  reportedBy   User?     @relation(fields: [reportedById], references: [id])
  
  // Police station handling this incident
  handlingStationId String?
  handlingStation   PoliceStation? @relation(fields: [handlingStationId], references: [id])
  
  reportedAt   DateTime  @default(now())
  resolvedAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([type])
  @@index([status])
  @@index([priority])
  @@index([severity])
  @@index([reportedAt])
  @@index([createdAt])
  @@index([externalId])
  @@map("incidents")
}

model Complaint {
  id           String        @id @default(uuid())
  type         ComplaintType
  title        String
  description  String?
  priority     String?       // HIGH, MEDIUM, LOW
  status       String        @default("PENDING") // PENDING, IN_PROGRESS, RESOLVED, CLOSED
  
  // Normalized location
  locationId   String?
  location     Location?     @relation(fields: [locationId], references: [id])
  
  complainerId String?
  complainer   User?         @relation(fields: [complainerId], references: [id])
  
  // Police station handling this complaint
  handlingStationId String?
  handlingStation   PoliceStation? @relation(fields: [handlingStationId], references: [id])
  
  resolvedAt   DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([type])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@map("complaints")
}

model CitizenGem {
  citizenId    String   @id
  citizen      User     @relation(fields: [citizenId], references: [id])
  amount       Int      @default(0)
  isRestricted Boolean  @default(false)
  lastUpdated  DateTime @default(now())
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("citizen_gems")
}

// Driving License Management System
model DrivingLicense {
  id              String    @id @default(uuid())
  licenseNo       String    @unique
  citizenId       String    
  citizen         User      @relation("DrivingLicenses", fields: [citizenId], references: [id])
  
  // License Details
  category        LicenseCategory // Enum for license categories
  issueDate       DateTime
  expiryDate      DateTime
  issuingAuthority String   // "BRTA", "DISTRICT_TRANSPORT", etc.
  
  // Status and Verification
  isActive        Boolean   @default(true)
  isVerified      Boolean   @default(false)
  verifiedBy      String?   // ID of admin/police who verified
  verifiedAt      DateTime?
  
  // Restrictions and endorsements
  restrictions    String?   // JSON array of restrictions ["NO_NIGHT_DRIVING", "CORRECTIVE_LENSES"]
  endorsements    String?   // JSON array of endorsements ["MOTORCYCLE", "MANUAL_TRANSMISSION"]
  
  // Violation tracking
  violationCount  Int       @default(0)
  lastViolationAt DateTime?
  isSuspended     Boolean   @default(false)
  suspendedUntil  DateTime?
  suspensionReason String?
  
  // Relations
  vehicleAssignments VehicleAssignment[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([licenseNo])
  @@index([citizenId])
  @@index([category])
  @@index([isActive])
  @@index([isVerified])
  @@index([expiryDate])
  @@map("driving_licenses")
}

// Vehicle Assignment System - tracks who is assigned to drive which vehicle
model VehicleAssignment {
  id          String    @id @default(uuid())
  vehicleId   String
  vehicle     Vehicle   @relation(fields: [vehicleId], references: [id])
  citizenId   String
  citizen     User      @relation("VehicleAssignments", fields: [citizenId], references: [id])
  
  assignedBy  String    // ID of the user who made the assignment (vehicle owner or admin)
  assignor    User      @relation("AssignmentsMade", fields: [assignedBy], references: [id])
  
  // Driving License Verification
  drivingLicenseId String?  // Required valid driving license
  drivingLicense   DrivingLicense? @relation(fields: [drivingLicenseId], references: [id])
  
  assignedAt  DateTime  @default(now())
  validFrom   DateTime  @default(now())
  validUntil  DateTime? // Optional expiry date for the assignment
  isActive    Boolean   @default(true)
  notes       String?   // Optional notes about the assignment
  
  // Assignment approval (for companies/organizations)
  requiresApproval Boolean  @default(false)
  isApproved      Boolean  @default(true)
  approvedBy      String?
  approvedAt      DateTime?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([vehicleId])
  @@index([citizenId])
  @@index([isActive])
  @@index([validFrom, validUntil])
  @@map("vehicle_assignments")
}
